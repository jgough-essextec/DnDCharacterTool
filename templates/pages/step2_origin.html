{% extends 'base/character_wizard.html' %}
{% load static %}

{% block step_content %}
<div x-data="originSelection()" class="space-y-8">
    <!-- Step Header -->
    <div class="text-center">
        <h2 class="text-3xl font-bold text-dnd-secondary mb-2">Choose Your Origin</h2>
        <p class="text-dnd-muted max-w-2xl mx-auto">
            Your origin consists of your species (what you are) and your background (what you did before adventuring).
            Together, they shape your character's story and abilities.
        </p>
    </div>

    <!-- Tab Navigation -->
    <div class="flex justify-center">
        <div class="bg-dnd-surface rounded-lg p-1 flex">
            <button @click="activeTab = 'species'"
                    :class="activeTab === 'species' ? 'bg-dnd-primary text-white' : 'text-dnd-muted hover:text-dnd-text'"
                    class="px-6 py-2 rounded-md font-medium transition-colors">
                Species
                <span x-show="selectedSpecies" class="ml-2 text-dnd-secondary">✓</span>
            </button>
            <button @click="activeTab = 'background'"
                    :class="activeTab === 'background' ? 'bg-dnd-primary text-white' : 'text-dnd-muted hover:text-dnd-text'"
                    class="px-6 py-2 rounded-md font-medium transition-colors">
                Background
                <span x-show="selectedBackground" class="ml-2 text-dnd-secondary">✓</span>
            </button>
            <button @click="activeTab = 'summary'"
                    :class="activeTab === 'summary' ? 'bg-dnd-primary text-white' : 'text-dnd-muted hover:text-dnd-text'"
                    class="px-6 py-2 rounded-md font-medium transition-colors"
                    :disabled="!selectedSpecies || !selectedBackground">
                Summary
                <span x-show="selectedSpecies && selectedBackground" class="ml-2 text-dnd-secondary">✓</span>
            </button>
        </div>
    </div>

    <!-- Species Tab -->
    <div x-show="activeTab === 'species'" x-transition:enter="fade-in">
        <!-- Recommendations -->
        {% if recommended_species %}
        <div class="dnd-card">
            <div class="flex items-center mb-4">
                <svg class="w-5 h-5 text-dnd-secondary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h3 class="font-semibold text-dnd-secondary">Recommended for {{ character.dnd_class.name|default:"Your Class" }}</h3>
            </div>
            <div class="flex flex-wrap gap-2">
                {% for species_name in recommended_species %}
                <span class="px-3 py-1 bg-dnd-secondary bg-opacity-20 text-dnd-secondary rounded-full text-sm">
                    {{ species_name }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Search -->
        <div class="dnd-card">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-dnd-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text"
                       x-model="speciesSearch"
                       @input="filterSpecies"
                       placeholder="Search species..."
                       class="dnd-input pl-10">
            </div>
        </div>

        <!-- Species Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="species in filteredSpecies" :key="species.id">
                <div class="species-card"
                     :class="{ 'selected': selectedSpecies?.id === species.id }"
                     @click="selectSpecies(species)">

                    <!-- Species Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-dnd-text" x-text="species.name"></h3>
                            <p class="text-sm text-dnd-muted" x-text="species.size + ' size'"></p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl" x-text="getSpeciesIcon(species.name)"></div>
                            <div class="text-xs text-dnd-muted" x-text="species.speed + ' ft'"></div>
                        </div>
                    </div>

                    <!-- Species Description -->
                    <p class="text-sm text-dnd-muted mb-4 line-clamp-3" x-text="species.description"></p>

                    <!-- Species Traits -->
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm" x-show="species.darkvision_range">
                            <span class="font-medium text-dnd-text w-20">Vision:</span>
                            <span class="text-dnd-muted" x-text="'Darkvision ' + species.darkvision_range + ' ft'"></span>
                        </div>
                        <div class="flex items-center text-sm" x-show="species.languages?.length">
                            <span class="font-medium text-dnd-text w-20">Languages:</span>
                            <span class="text-dnd-muted" x-text="species.languages?.join(', ')"></span>
                        </div>
                    </div>

                    <!-- Selection Indicator -->
                    <div x-show="selectedSpecies?.id === species.id"
                         class="absolute top-2 right-2 bg-dnd-secondary text-black rounded-full p-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Background Tab -->
    <div x-show="activeTab === 'background'" x-transition:enter="fade-in">
        <!-- Recommendations -->
        {% if recommended_backgrounds %}
        <div class="dnd-card">
            <div class="flex items-center mb-4">
                <svg class="w-5 h-5 text-dnd-secondary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h3 class="font-semibold text-dnd-secondary">Recommended for {{ character.dnd_class.name|default:"Your Class" }}</h3>
            </div>
            <div class="flex flex-wrap gap-2">
                {% for bg_name in recommended_backgrounds %}
                <span class="px-3 py-1 bg-dnd-secondary bg-opacity-20 text-dnd-secondary rounded-full text-sm">
                    {{ bg_name }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Search -->
        <div class="dnd-card">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-dnd-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text"
                       x-model="backgroundSearch"
                       @input="filterBackgrounds"
                       placeholder="Search backgrounds..."
                       class="dnd-input pl-10">
            </div>
        </div>

        <!-- Background Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <template x-for="background in filteredBackgrounds" :key="background.id">
                <div class="background-card"
                     :class="{ 'selected': selectedBackground?.id === background.id }"
                     @click="selectBackground(background)">

                    <!-- Background Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-dnd-text" x-text="background.name"></h3>
                            <p class="text-sm text-dnd-muted">Background</p>
                        </div>
                        <div class="text-2xl" x-text="getBackgroundIcon(background.name)"></div>
                    </div>

                    <!-- Background Description -->
                    <p class="text-sm text-dnd-muted mb-4 line-clamp-4" x-text="background.description"></p>

                    <!-- Background Features -->
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm" x-show="background.skill_proficiencies?.length">
                            <span class="font-medium text-dnd-text w-20">Skills:</span>
                            <span class="text-dnd-muted text-xs" x-text="background.skill_proficiencies?.join(', ')"></span>
                        </div>
                        <div class="flex items-center text-sm" x-show="background.tool_proficiencies?.length">
                            <span class="font-medium text-dnd-text w-20">Tools:</span>
                            <span class="text-dnd-muted text-xs" x-text="background.tool_proficiencies?.join(', ')"></span>
                        </div>
                    </div>

                    <!-- Selection Indicator -->
                    <div x-show="selectedBackground?.id === background.id"
                         class="absolute top-2 right-2 bg-blue-600 text-white rounded-full p-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Summary Tab -->
    <div x-show="activeTab === 'summary'" x-transition:enter="fade-in">
        <div x-show="selectedSpecies && selectedBackground">
            <div class="dnd-card">
                <h3 class="text-2xl font-bold text-dnd-secondary mb-6 text-center">Your Character Origin</h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Species Summary -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl" x-text="getSpeciesIcon(selectedSpecies?.name)"></div>
                            <div>
                                <h4 class="text-xl font-bold text-dnd-text" x-text="selectedSpecies?.name"></h4>
                                <p class="text-dnd-muted">Species</p>
                            </div>
                        </div>

                        <p class="text-sm text-dnd-muted" x-text="selectedSpecies?.description"></p>

                        <div class="space-y-2">
                            <h5 class="font-semibold text-dnd-text">Species Traits</h5>
                            <div class="text-sm space-y-1">
                                <div class="flex">
                                    <span class="font-medium text-dnd-text w-20">Size:</span>
                                    <span class="text-dnd-muted" x-text="selectedSpecies?.size"></span>
                                </div>
                                <div class="flex">
                                    <span class="font-medium text-dnd-text w-20">Speed:</span>
                                    <span class="text-dnd-muted" x-text="selectedSpecies?.speed + ' feet'"></span>
                                </div>
                                <div class="flex" x-show="selectedSpecies?.darkvision_range">
                                    <span class="font-medium text-dnd-text w-20">Vision:</span>
                                    <span class="text-dnd-muted" x-text="'Darkvision ' + selectedSpecies?.darkvision_range + ' ft'"></span>
                                </div>
                                <div class="flex" x-show="selectedSpecies?.languages?.length">
                                    <span class="font-medium text-dnd-text w-20">Languages:</span>
                                    <span class="text-dnd-muted" x-text="selectedSpecies?.languages?.join(', ')"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Background Summary -->
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="text-3xl" x-text="getBackgroundIcon(selectedBackground?.name)"></div>
                            <div>
                                <h4 class="text-xl font-bold text-dnd-text" x-text="selectedBackground?.name"></h4>
                                <p class="text-dnd-muted">Background</p>
                            </div>
                        </div>

                        <p class="text-sm text-dnd-muted" x-text="selectedBackground?.description"></p>

                        <div class="space-y-2">
                            <h5 class="font-semibold text-dnd-text">Background Features</h5>
                            <div class="text-sm space-y-1">
                                <div class="flex" x-show="selectedBackground?.skill_proficiencies?.length">
                                    <span class="font-medium text-dnd-text w-20">Skills:</span>
                                    <span class="text-dnd-muted" x-text="selectedBackground?.skill_proficiencies?.join(', ')"></span>
                                </div>
                                <div class="flex" x-show="selectedBackground?.tool_proficiencies?.length">
                                    <span class="font-medium text-dnd-text w-20">Tools:</span>
                                    <span class="text-dnd-muted" x-text="selectedBackground?.tool_proficiencies?.join(', ')"></span>
                                </div>
                                <div class="flex" x-show="selectedBackground?.starting_gold">
                                    <span class="font-medium text-dnd-text w-20">Gold:</span>
                                    <span class="text-dnd-muted" x-text="selectedBackground?.starting_gold + ' gp'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Combined Identity -->
                <div class="mt-8 pt-6 border-t border-dnd text-center">
                    <h5 class="text-lg font-semibold text-dnd-secondary mb-2">Your Character Identity</h5>
                    <p class="text-dnd-text text-lg">
                        <span class="font-bold" x-text="selectedSpecies?.name"></span>
                        <span class="text-dnd-muted mx-2">•</span>
                        <span class="font-bold" x-text="selectedBackground?.name"></span>
                    </p>
                    <p class="text-sm text-dnd-muted mt-2">
                        A <span x-text="selectedSpecies?.name.toLowerCase()"></span> with a <span x-text="selectedBackground?.name.toLowerCase()"></span> background
                    </p>
                </div>
            </div>
        </div>

        <!-- Incomplete Selection -->
        <div x-show="!selectedSpecies || !selectedBackground" class="dnd-card text-center">
            <h3 class="text-xl font-bold text-dnd-text mb-4">Complete Your Origin Selection</h3>
            <p class="text-dnd-muted mb-6">Please select both a species and background to continue.</p>

            <div class="flex justify-center space-x-4">
                <button x-show="!selectedSpecies"
                        @click="activeTab = 'species'"
                        class="dnd-button-outline">
                    Choose Species
                </button>
                <button x-show="!selectedBackground"
                        @click="activeTab = 'background'"
                        class="dnd-button-outline">
                    Choose Background
                </button>
            </div>
        </div>
    </div>

    <!-- Form Inputs -->
    <input type="hidden" name="species_id" :value="selectedSpecies?.id">
    <input type="hidden" name="background_id" :value="selectedBackground?.id">
</div>

<script>
    function originSelection() {
        return {
            activeTab: 'species',
            species: {{ species|safe }},
            backgrounds: {{ backgrounds|safe }},
            selectedSpecies: {% if selected_species %}{{ selected_species|safe }}{% else %}null{% endif %},
            selectedBackground: {% if selected_background %}{{ selected_background|safe }}{% else %}null{% endif %},
            speciesSearch: '',
            backgroundSearch: '',
            filteredSpecies: [],
            filteredBackgrounds: [],

            init() {
                this.filteredSpecies = this.species;
                this.filteredBackgrounds = this.backgrounds;

                // Auto-switch to background tab if species is already selected
                if (this.selectedSpecies && !this.selectedBackground) {
                    this.activeTab = 'background';
                }
            },

            selectSpecies(species) {
                this.selectedSpecies = species;
                this.saveSelection();

                // Auto-advance to background tab if not selected
                if (!this.selectedBackground) {
                    setTimeout(() => {
                        this.activeTab = 'background';
                    }, 300);
                }
            },

            selectBackground(background) {
                this.selectedBackground = background;
                this.saveSelection();

                // Auto-advance to summary if both selected
                if (this.selectedSpecies) {
                    setTimeout(() => {
                        this.activeTab = 'summary';
                    }, 300);
                }
            },

            async saveSelection() {
                try {
                    const data = {};
                    if (this.selectedSpecies) data.species = this.selectedSpecies.id;
                    if (this.selectedBackground) data.background = this.selectedBackground.id;

                    await DnDApp.utils.apiRequest(`/characters/api/${DnDApp.characterState.characterId}/`, {
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });
                } catch (error) {
                    console.error('Failed to save origin selection:', error);
                }
            },

            filterSpecies() {
                if (!this.speciesSearch) {
                    this.filteredSpecies = this.species;
                    return;
                }

                const query = this.speciesSearch.toLowerCase();
                this.filteredSpecies = this.species.filter(species =>
                    species.name.toLowerCase().includes(query) ||
                    species.description.toLowerCase().includes(query)
                );
            },

            filterBackgrounds() {
                if (!this.backgroundSearch) {
                    this.filteredBackgrounds = this.backgrounds;
                    return;
                }

                const query = this.backgroundSearch.toLowerCase();
                this.filteredBackgrounds = this.backgrounds.filter(bg =>
                    bg.name.toLowerCase().includes(query) ||
                    bg.description.toLowerCase().includes(query)
                );
            },

            getSpeciesIcon(speciesName) {
                const icons = {
                    'Human': '👤',
                    'Elf': '🧝',
                    'Dwarf': '🧔',
                    'Halfling': '🧙‍♂️',
                    'Dragonborn': '🐲',
                    'Gnome': '🎩',
                    'Half-Elf': '🧝‍♀️',
                    'Half-Orc': '👹',
                    'Tiefling': '😈',
                    'Orc': '👹',
                    'Goliath': '⛰️',
                    'Aasimar': '😇'
                };
                return icons[speciesName] || '👤';
            },

            getBackgroundIcon(backgroundName) {
                const icons = {
                    'Acolyte': '⛪',
                    'Criminal': '🗡️',
                    'Folk Hero': '🛡️',
                    'Noble': '👑',
                    'Sage': '📚',
                    'Soldier': '⚔️',
                    'Charlatan': '🎭',
                    'Entertainer': '🎵',
                    'Guild Artisan': '🔨',
                    'Hermit': '🏔️',
                    'Outlander': '🌲',
                    'Sailor': '⚓'
                };
                return icons[backgroundName] || '📋';
            }
        }
    }
</script>
{% endblock %}

{% block help_content %}
<div class="space-y-3">
    <h4 class="font-semibold text-dnd-secondary">Choosing Your Origin</h4>
    <p>Your origin shapes both your abilities and your character's story.</p>

    <h5 class="font-medium text-dnd-text">Species:</h5>
    <ul class="text-xs space-y-1">
        <li>• Determines physical traits and natural abilities</li>
        <li>• Provides ability score bonuses</li>
        <li>• Grants special features like darkvision</li>
    </ul>

    <h5 class="font-medium text-dnd-text">Background:</h5>
    <ul class="text-xs space-y-1">
        <li>• Represents your pre-adventuring life</li>
        <li>• Provides skill and tool proficiencies</li>
        <li>• Gives starting equipment and connections</li>
    </ul>

    <h5 class="font-medium text-dnd-text">Recommendations:</h5>
    <p class="text-xs">The highlighted options work especially well with your chosen class, but any combination is viable!</p>
</div>
{% endblock %}